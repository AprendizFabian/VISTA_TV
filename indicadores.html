<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LUM – Indicadores</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --lum-green-dark:#0b3113;
  --lum-green:#14532d;
  --lum-green-soft:#f2fff5;

  --ok-bg:#10b981;
  --ok-text:#ffffff;

  --warn-bg:#f59e0b;
  --warn-text:#ffffff;

  --bad-bg:#ef4444;
  --bad-text:#ffffff;
}

/* RESET */
*{margin:0;padding:0;box-sizing:border-box;}

body{
  background:#ffffff;
  font-family:"Poppins",sans-serif;
  height:100vh;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
}

/* ESQUINAS */
.corner-black{
  position:absolute;top:0;left:0;
  width:0;height:0;
  border-left:260px solid #000;
  border-bottom:190px solid transparent;
  z-index:1;
}
.corner-yellow{
  position:absolute;bottom:0;right:0;
  width:0;height:0;
  border-right:220px solid #FFD60A;
  border-top:180px solid transparent;
  z-index:1;
}

/* LOGO */
.logo{
  position:absolute;
  top:22px;left:22px;
  width:95px;
  z-index:50;
  animation:floatLogo 3s ease-in-out infinite alternate;
  transition:1s ease;
}
@keyframes floatLogo{
  0%{transform:translateY(0);}
  100%{transform:translateY(7px);}
}
.logo.hide{
  transform:scale(0) translate(-50%,-50%);
  opacity:0;
  position:fixed;
  top:50%;left:50%;
}

/* PANTALLA CARGA */
.carga{
  position:fixed;
  inset:0;
  background:white;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:999;
  transition:opacity 1s;
}
.carga img{
  width:350px;
  animation:fadeIn 2s ease;
}
@keyframes fadeIn{
  0%{opacity:0;transform:scale(.93);}
  100%{opacity:1;transform:scale(1);}
}
.carga.oculta{
  opacity:0;
  pointer-events:none;
}

/* FADE DE SALIDA */
.fade-overlay{
  position:fixed;
  inset:0;
  background:white;
  opacity:0;
  transition:opacity 1s;
  z-index:900;
}
.fade-overlay.activo{
  opacity:1;
}

/* CONTENEDOR PRINCIPAL */
.content{
  opacity:0;
  transform:translateY(20px);
  transition:1s;
  width:100%;
  max-width:1500px;
  z-index:10;
}
.content.visible{
  opacity:1;
  transform:translateY(0);
}

/* HOJA */
.sheet{
  border:4px solid var(--lum-green-dark);
  border-radius:8px;
  overflow:hidden;
  background:#ffffff;
  box-shadow:0 10px 40px rgba(0,0,0,.25);
}

/* CINTA SUPERIOR */
.sheet-top{
  background:var(--lum-green-dark);
  color:#fff;
  padding:12px 22px;
  font-size:15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.sheet-title{
  font-size:38px;
  font-weight:800;
  letter-spacing:1px;
}
.sheet-field{
  display:flex;
  gap:6px;
  align-items:center;
  margin-left:25px;
}
.sheet-field-label{
  font-weight:700;
  text-transform:uppercase;
}
.sheet-field-box{
  background:#f2fff5;
  color:#111;
  padding:3px 12px;
  border-radius:2px;
  font-weight:600;
  min-width:170px;
  text-align:center;
  font-size:17px;
}

/* TABLA PRINCIPAL */
.sheet-main{
  background:#f7fff8;
  padding:10px 12px 14px;
}

.table-indicadores{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:18px;
}

.table-indicadores th,
.table-indicadores td{
  border:1px solid #d4ead4;
  padding:10px 8px;
}

/* HEAD */
.table-indicadores thead th{
  background:#dfeee0;
  color:#1f2933;
  font-weight:800;
  text-align:center;
  font-size:18px;
}

/* COLUMNA IZQUIERDA */
.row-label{
  background:var(--lum-green);
  color:#ffffff;
  font-weight:700;
  text-align:left;
  font-size:20px;
  padding-left:10px;
  width:170px;
}

/* FILAS */
.table-indicadores tbody tr:nth-child(odd){
  background:#f4fff7;
}
.table-indicadores tbody tr:nth-child(even){
  background:#e9f7eb;
}

.tr-meta{
  background:#dff7e2 !important;
}
.tr-meta .row-label{
  background:#124d2b;
}

/* COLORES */
.cell{
  font-weight:700;
  text-align:center;
  font-size:19px;
}
.cell-ok{
  background:var(--ok-bg);
  color:var(--ok-text);
}
.cell-warn{
  background:var(--warn-bg);
  color:var(--warn-text);
}
.cell-bad{
  background:var(--bad-bg);
  color:var(--bad-text);
}
</style>
</head>

<body>

<div class="corner-black"></div>
<div class="corner-yellow"></div>

<div class="carga" id="pantallaCarga">
  <img src="img/carga.png">
</div>
<div class="fade-overlay" id="fadeOverlay"></div>


<div class="content" id="mainContent">

  <div class="sheet">

    <div class="sheet-top">
      <div class="sheet-title">INDICADORES</div>
      <div style="display:flex;">
        <div class="sheet-field">
          <span class="sheet-field-label">DARKSTORE:</span>
          <span class="sheet-field-box" id="campoDarkstore">—</span>
        </div>
        <div class="sheet-field">
          <span class="sheet-field-label">MES:</span>
          <span class="sheet-field-box" id="campoMes">—</span>
        </div>
      </div>
    </div>

    <div class="sheet-main">
      <table class="table-indicadores">
        <thead>
          <tr>
            <th class="row-label"></th>
            <th># ÓRDENES</th>
            <th>% DEFECT RATE</th>
            <th>IN STORE</th>
          </tr>
        </thead>
        <tbody id="tablaBody"></tbody>
      </table>
    </div>

  </div>

</div>

<script>

const API_MES_PASADO = "https://proxy-eight-taupe-93.vercel.app/api/mesPasado.js";
const API_MES_ACTUAL  = "https://proxy-eight-taupe-93.vercel.app/api/mesActual.js";
const SHEET =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vSUqiPVe2z89H6Gum_WF-13kMUpXse9-epmDlqkurHE9DFp_zUKt1dT4ptzyLfsi3SM8fTXf-AmJvea/pub?gid=1247726367&single=true&output=tsv";

const tiendaURL = new URLSearchParams(location.search).get("tienda") || "";

const DURACION = 15000;

const num = v => v==null||v==="" ? null : Number(v);

function parseMeta(v){
  if(!v) return null;
  return Number(v.replace(",","."));
}

function getMetas(tsv){
  const rows = tsv.trim().split("\n").map(r=>r.split("\t"));
  const f = rows[1];
  return {
    ordenes:null,
    defect : parseMeta(f[3]),
    instore: parseMeta(f[4])
  };
}

function metaClass(v,m){
  if(v==null || m==null) return "";
  if(v<=m) return "cell-ok";
  if(v<=m*1.2) return "cell-warn";
  return "cell-bad";
}

async function cargarIndicadores(){
  const [p,a,m] = await Promise.all([
    fetch(API_MES_PASADO).then(r=>r.json()),
    fetch(API_MES_ACTUAL).then(r=>r.json()),
    fetch(SHEET).then(r=>r.text())
  ]);

  const metas = getMetas(m);

  const rP = p?.query_result?.data?.rows?.[0];
  const pasado = rP ? {
    tienda:rP.Tienda,
    ordenes:num(rP.Ordenes),
    defect:num(rP.DefectRate),
    instore:num(rP.InStoreTime)
  }:null;

  const semanas = (a?.query_result?.data?.rows || []).map((x,i)=>({
    etiqueta:`SEMANA ${i+1}`,
    ordenes:num(x.Ordenes),
    defect:num(x.DefectRate),
    instore:num(x.InStoreTime)
  }));

  document.getElementById("campoDarkstore").textContent =
    tiendaURL || pasado?.tienda || semanas[0]?.tienda || "—";

  document.getElementById("campoMes").textContent =
    new Date().toLocaleString("es-CO",{month:"long"}).toUpperCase();

  let html="";

  html+=`
    <tr class="tr-meta">
      <th class="row-label">METAS DEL MES</th>
      <td class="cell">—</td>
      <td class="cell">${metas.defect!=null? metas.defect+"%":"—"}</td>
      <td class="cell">${metas.instore!=null? metas.instore+"m":"—"}</td>
    </tr>
  `;

  if(pasado){
    html+=`
      <tr>
        <th class="row-label">MES PASADO</th>
        <td class="cell">${pasado.ordenes?.toLocaleString("es-CO") ?? "—"}</td>
        <td class="cell ${metaClass(pasado.defect,metas.defect)}">${pasado.defect ?? "—"}%</td>
        <td class="cell ${metaClass(pasado.instore,metas.instore)}">${pasado.instore ?? "—"}m</td>
      </tr>
    `;
  }

  semanas.forEach(s=>{
    html+=`
      <tr>
        <th class="row-label">${s.etiqueta}</th>
        <td class="cell">${s.ordenes?.toLocaleString("es-CO") ?? "—"}</td>
        <td class="cell ${metaClass(s.defect,metas.defect)}">${s.defect ?? "—"}%</td>
        <td class="cell ${metaClass(s.instore,metas.instore)}">${s.instore ?? "—"}m</td>
      </tr>
    `;
  });

  if(semanas.length){
    const tot = semanas.reduce((a,b)=>a+(b.ordenes||0),0);
    const avgD = semanas.reduce((a,b)=>a+(b.defect||0),0)/semanas.length;
    const avgI = semanas.reduce((a,b)=>a+(b.instore||0),0)/semanas.length;

    html+=`
      <tr>
        <th class="row-label">TOTAL MES</th>
        <td class="cell">${tot.toLocaleString("es-CO")}</td>
        <td class="cell ${metaClass(avgD,metas.defect)}">${avgD.toFixed(2)}%</td>
        <td class="cell ${metaClass(avgI,metas.instore)}">${avgI.toFixed(2)}m</td>
      </tr>
    `;
  }

  document.getElementById("tablaBody").innerHTML = html;
}

function animarSalida(){
  document.getElementById("logo").classList.add("hide");
  document.getElementById("fadeOverlay").classList.add("activo");
  setTimeout(()=>{
    location.href=`cumple.html?tienda=${encodeURIComponent(tiendaURL)}`;
  },1000);
}

window.addEventListener("load", async ()=>{
  await cargarIndicadores();
  document.getElementById("pantallaCarga").classList.add("oculta");
  document.getElementById("mainContent").classList.add("visible");
  setTimeout(animarSalida,DURACION);
});

</script>

</body>
</html>
